{% extends "admin/base.html" %}

{% block title %}{{ restaurant.name }} - Admin{% endblock %}

{% block admin_content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-utensils me-2"></i>{{ restaurant.name }}</h2>
            <p class="text-muted mb-0">
                {{ restaurant.cuisine_type or 'Restaurant' }} 
                {% if restaurant.city %} &bull; {{ restaurant.city }}{% endif %}
            </p>
        </div>
        <div class="btn-group">
            <a href="{{ url_for('admin.edit_restaurant', id=restaurant.id) }}" class="btn btn-outline-primary">
                <i class="fas fa-edit me-1"></i> Edit
            </a>
            <a href="{{ url_for('admin.restaurants') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Tables</h6>
                            <h2 class="mb-0">{{ stats.tables }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chair fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Today's Reservations</h6>
                            <h2 class="mb-0">{{ stats.today_reservations }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar-check fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Total Reservations</h6>
                            <h2 class="mb-0">{{ stats.total_reservations }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-book fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">AI Conversations</h6>
                            <h2 class="mb-0">{{ stats.ai_conversations }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-robot fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <a href="{{ url_for('admin.floor_plan_editor', restaurant_id=restaurant.id) }}" class="btn btn-outline-primary w-100 py-3">
                                <i class="fas fa-th fa-2x d-block mb-2"></i>
                                Floor Plan Editor
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('admin.tables', restaurant_id=restaurant.id) }}" class="btn btn-outline-success w-100 py-3">
                                <i class="fas fa-chair fa-2x d-block mb-2"></i>
                                Manage Tables
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('admin.chatwoot_settings', id=restaurant.id) }}" class="btn btn-outline-info w-100 py-3">
                                <i class="fas fa-comments fa-2x d-block mb-2"></i>
                                Chatwoot Settings
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('admin.widget_code', id=restaurant.id) }}" class="btn btn-outline-warning w-100 py-3">
                                <i class="fas fa-code fa-2x d-block mb-2"></i>
                                Widget Code
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('admin.knowledge_base', id=restaurant.id) }}" class="btn btn-outline-secondary w-100 py-3">
                                <i class="fas fa-book-open fa-2x d-block mb-2"></i>
                                Knowledge Base
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('admin.reservations') }}?restaurant_id={{ restaurant.id }}" class="btn btn-outline-dark w-100 py-3">
                                <i class="fas fa-calendar-alt fa-2x d-block mb-2"></i>
                                Reservations
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Reservations -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-calendar me-2"></i>Recent Reservations</h5>
                    <a href="{{ url_for('admin.reservations') }}?restaurant_id={{ restaurant.id }}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="card-body p-0">
                    {% if recent_reservations %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Guest</th>
                                    <th>Party</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reservation in recent_reservations %}
                                <tr>
                                    <td>{{ reservation.reservation_date.strftime('%b %d, %Y') }}</td>
                                    <td>{{ reservation.reservation_time.strftime('%I:%M %p') }}</td>
                                    <td>{{ reservation.customer_name }}</td>
                                    <td>{{ reservation.party_size }} guests</td>
                                    <td>
                                        {% if reservation.status == 'confirmed' %}
                                        <span class="badge bg-success">Confirmed</span>
                                        {% elif reservation.status == 'pending' %}
                                        <span class="badge bg-warning text-dark">Pending</span>
                                        {% elif reservation.status == 'cancelled' %}
                                        <span class="badge bg-danger">Cancelled</span>
                                        {% elif reservation.status == 'completed' %}
                                        <span class="badge bg-info">Completed</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ reservation.status }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-calendar-times fa-3x mb-3"></i>
                        <p>No reservations yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Restaurant Info -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Restaurant Info</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td class="text-muted">Status</td>
                            <td>
                                {% if restaurant.is_active %}
                                <span class="badge bg-success">Active</span>
                                {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                                {% if restaurant.is_live %}
                                <span class="badge bg-primary">Live</span>
                                {% else %}
                                <span class="badge bg-warning text-dark">Test Mode</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Address</td>
                            <td>
                                {% if restaurant.address %}
                                {{ restaurant.address }}<br>
                                {{ restaurant.city }}, {{ restaurant.state }} {{ restaurant.zip_code }}
                                {% else %}
                                <span class="text-muted">Not set</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Phone</td>
                            <td>{{ restaurant.phone or 'Not set' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Email</td>
                            <td>{{ restaurant.email or 'Not set' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Cuisine</td>
                            <td>{{ restaurant.cuisine_type or 'Not set' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Timezone</td>
                            <td>{{ restaurant.timezone }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Chatwoot Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Chatwoot Integration</h5>
                </div>
                <div class="card-body">
                    {% if restaurant.chatwoot_api_key and restaurant.chatwoot_account_id %}
                    <div class="alert alert-success mb-3">
                        <i class="fas fa-check-circle me-2"></i>Connected
                    </div>
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td class="text-muted">Account ID</td>
                            <td>{{ restaurant.chatwoot_account_id }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Inbox ID</td>
                            <td>{{ restaurant.chatwoot_inbox_id or 'Not set' }}</td>
                        </tr>
                    </table>
                    {% else %}
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>Not configured
                    </div>
                    <a href="{{ url_for('admin.chatwoot_settings', id=restaurant.id) }}" class="btn btn-primary btn-sm">
                        Configure Chatwoot
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- AI Chat Test -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-robot me-2"></i>Test AI Assistant</h5>
                </div>
                <div class="card-body">
                    <div id="chat-container" style="height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem; margin-bottom: 1rem; background: #f8f9fa;">
                        <div id="chat-messages">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-comments fa-2x mb-2"></i>
                                <p class="mb-0">Start a conversation to test the AI</p>
                            </div>
                        </div>
                    </div>
                    <form id="chat-form" class="d-flex gap-2">
                        <input type="text" id="chat-input" class="form-control" placeholder="Type a message...">
                        <button type="submit" class="btn btn-primary" title="Send message">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button type="button" id="mic-btn" class="btn btn-outline-secondary" title="Record audio message">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </form>
                    <div id="recording-status" class="text-center mt-2" style="display: none;">
                        <span class="badge bg-danger"><i class="fas fa-circle me-1"></i> Recording...</span>
                        <button type="button" id="stop-recording-btn" class="btn btn-sm btn-danger ms-2">Stop</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- WhatsApp Floating Button -->
{% set whatsapp_phone = (restaurant.whatsapp_number or restaurant.phone or '')|replace('+', '')|replace(' ', '')|replace('-', '')|replace('(', '')|replace(')', '') %}
{% if whatsapp_phone and whatsapp_phone|length > 5 and whatsapp_phone != 'Tbd' %}
<a href="https://wa.me/{{ whatsapp_phone }}?text=Hi, I would like to make a reservation at {{ restaurant.name }}" 
   target="_blank" 
   class="whatsapp-float" 
   title="Chat on WhatsApp">
    <i class="fab fa-whatsapp"></i>
</a>
{% endif %}

<style>
.whatsapp-float {
    position: fixed;
    width: 60px;
    height: 60px;
    bottom: 40px;
    right: 40px;
    background-color: #25d366;
    color: #FFF;
    border-radius: 50px;
    text-align: center;
    font-size: 30px;
    box-shadow: 2px 2px 10px rgba(0,0,0,0.3);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: all 0.3s ease;
}
.whatsapp-float:hover {
    background-color: #128c7e;
    color: #FFF;
    transform: scale(1.1);
}
#mic-btn.recording {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
    animation: pulse 1s infinite;
}
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');
    const chatContainer = document.getElementById('chat-container');
    let conversationStarted = false;

    function addMessage(text, isUser) {
        if (!conversationStarted) {
            chatMessages.innerHTML = '';
            conversationStarted = true;
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-2 ${isUser ? 'text-end' : ''}`;
        messageDiv.innerHTML = `
            <div class="d-inline-block p-2 rounded ${isUser ? 'bg-primary text-white' : 'bg-white border'}" style="max-width: 80%;">
                ${text}
            </div>
        `;
        chatMessages.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function addTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.id = 'typing-indicator';
        indicator.className = 'mb-2';
        indicator.innerHTML = `
            <div class="d-inline-block p-2 rounded bg-white border">
                <i class="fas fa-circle-notch fa-spin me-1"></i> AI is typing...
            </div>
        `;
        chatMessages.appendChild(indicator);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const message = chatInput.value.trim();
        if (!message) return;
        
        addMessage(message, true);
        chatInput.value = '';
        addTypingIndicator();
        
        try {
            const response = await fetch('/api/ai/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    restaurant_id: {{ restaurant.id }}
                })
            });
            
            const data = await response.json();
            removeTypingIndicator();
            
            if (data.response) {
                // Parse the response - it may be a JSON string with a 'text' field
                let displayText = data.response;
                try {
                    // If response is a string that looks like JSON, parse it
                    if (typeof data.response === 'string' && data.response.startsWith('{')) {
                        const parsed = JSON.parse(data.response);
                        displayText = parsed.text || data.response;
                    } else if (typeof data.response === 'object' && data.response.text) {
                        displayText = data.response.text;
                    }
                } catch (e) {
                    // If parsing fails, use the original response
                    displayText = data.response;
                }
                addMessage(displayText, false);
            } else if (data.error) {
                addMessage('Error: ' + data.error, false);
            }
        } catch (error) {
            removeTypingIndicator();
            addMessage('Error: Could not connect to AI', false);
        }
    });

    // Audio Recording Functionality
    const micBtn = document.getElementById('mic-btn');
    const recordingStatus = document.getElementById('recording-status');
    const stopRecordingBtn = document.getElementById('stop-recording-btn');
    let mediaRecorder = null;
    let audioChunks = [];

    micBtn.addEventListener('click', async function() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            // Stop recording
            mediaRecorder.stop();
            return;
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                // Stop all tracks
                stream.getTracks().forEach(track => track.stop());
                
                // Reset UI
                micBtn.classList.remove('recording');
                micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                recordingStatus.style.display = 'none';

                // Create audio blob and send for transcription
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                await sendAudioForTranscription(audioBlob);
            };

            mediaRecorder.start();
            micBtn.classList.add('recording');
            micBtn.innerHTML = '<i class="fas fa-stop"></i>';
            recordingStatus.style.display = 'block';

        } catch (error) {
            console.error('Error accessing microphone:', error);
            alert('Could not access microphone. Please ensure you have granted permission.');
        }
    });

    stopRecordingBtn.addEventListener('click', function() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
    });

    async function sendAudioForTranscription(audioBlob) {
        addMessage('<i class="fas fa-microphone me-1"></i> Audio message', true);
        addTypingIndicator();

        try {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.webm');
            formData.append('restaurant_id', {{ restaurant.id }});

            const response = await fetch('/api/ai/transcribe', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            removeTypingIndicator();

            if (data.transcription) {
                // Show the transcribed text
                addMessage('You said: "' + data.transcription + '"', true);
                
                // Now send the transcribed text to the AI chat
                addTypingIndicator();
                const chatResponse = await fetch('/api/ai/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: data.transcription,
                        restaurant_id: {{ restaurant.id }}
                    })
                });

                const chatData = await chatResponse.json();
                removeTypingIndicator();

                if (chatData.response) {
                    let displayText = chatData.response;
                    try {
                        if (typeof chatData.response === 'string' && chatData.response.startsWith('{')) {
                            const parsed = JSON.parse(chatData.response);
                            displayText = parsed.text || chatData.response;
                        } else if (typeof chatData.response === 'object' && chatData.response.text) {
                            displayText = chatData.response.text;
                        }
                    } catch (e) {
                        displayText = chatData.response;
                    }
                    addMessage(displayText, false);
                } else if (chatData.error) {
                    addMessage('Error: ' + chatData.error, false);
                }
            } else if (data.error) {
                addMessage('Error transcribing audio: ' + data.error, false);
            }
        } catch (error) {
            removeTypingIndicator();
            addMessage('Error: Could not process audio', false);
        }
    }
});
</script>
{% endblock %}
