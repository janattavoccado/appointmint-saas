{% extends "admin/base.html" %}

{% block title %}{{ restaurant.name }} - AppointMint{% endblock %}

{% block admin_content %}
<div class="page-header">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="{{ url_for('admin.restaurants') }}">Restaurants</a></li>
                <li class="breadcrumb-item active">{{ restaurant.name }}</li>
            </ol>
        </nav>
        <h1 class="page-title">{{ restaurant.name }}</h1>
        <p class="page-subtitle">{{ restaurant.cuisine_type or 'Restaurant' }} â€¢ {{ restaurant.city }}</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('admin.chatwoot_settings', id=restaurant.id) }}" class="btn btn-outline-success">
            <i class="fas fa-comments me-2"></i>Chatwoot Integration
        </a>
        <a href="{{ url_for('admin.knowledge_base', id=restaurant.id) }}" class="btn btn-outline-info">
            <i class="fas fa-book me-2"></i>Knowledge Base
        </a>
        {% if restaurant.tenant and restaurant.tenant.is_paid %}
        <a href="{{ url_for('admin.widget_code', id=restaurant.id) }}" class="btn btn-outline-primary">
            <i class="fas fa-code me-2"></i>Get Widget
        </a>
        {% else %}
        <a href="{{ url_for('billing.go_live', restaurant_id=restaurant.id) }}" class="btn btn-success">
            <i class="fas fa-rocket me-2"></i>Go Live
        </a>
        {% endif %}
        <a href="{{ url_for('admin.edit_restaurant', id=restaurant.id) }}" class="btn btn-primary">
            <i class="fas fa-edit me-2"></i>Edit
        </a>
    </div>
</div>

<!-- Stats Row -->
<div class="row g-4 mb-4">
    <div class="col-md-6 col-xl-3">
        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="fas fa-chair"></i>
            </div>
            <div class="stat-value">{{ stats.tables if stats else (restaurant.tables|length if restaurant.tables else 0) }}</div>
            <div class="stat-label">Tables</div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="stat-card success">
            <div class="stat-icon success">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-value">{{ stats.today_reservations if stats else 0 }}</div>
            <div class="stat-label">Today's Reservations</div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="stat-card info">
            <div class="stat-icon info">
                <i class="fas fa-book"></i>
            </div>
            <div class="stat-value">{{ stats.total_reservations if stats else (restaurant.reservations|length if restaurant.reservations else 0) }}</div>
            <div class="stat-label">Total Reservations</div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="stat-card warning">
            <div class="stat-icon warning">
                <i class="fas fa-robot"></i>
            </div>
            <div class="stat-value">{{ stats.ai_conversations if stats else 0 }}</div>
            <div class="stat-label">AI Conversations</div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- AI Assistant Test -->
    <div class="col-lg-7">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title">AI Reservation Assistant</h5>
                    <p class="card-subtitle text-muted mb-0">Test the AI assistant for {{ restaurant.name }}</p>
                </div>
                <span class="badge bg-success"><i class="fas fa-circle me-1" style="font-size: 8px;"></i>Live</span>
            </div>
            <div class="card-body p-0">
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message assistant">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-text">
                                    Welcome to {{ restaurant.name }}! I'm your AI reservation assistant. How can I help you today? You can ask me to:
                                    <ul class="mt-2 mb-0">
                                        <li>Make a reservation</li>
                                        <li>Check availability</li>
                                        <li>Get restaurant information</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
                        <button class="chat-send-btn" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button class="chat-voice-btn" id="voiceBtn">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <a href="https://wa.me/12134495602?text=Hi!%20I'd%20like%20to%20make%20a%20reservation%20at%20{{ restaurant.name | urlencode }}." 
                           class="chat-whatsapp-btn" 
                           target="_blank" 
                           rel="noopener noreferrer"
                           title="Chat on WhatsApp">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor" width="20" height="20">
                                <path d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Restaurant Info -->
    <div class="col-lg-5">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title">Restaurant Info</h5>
            </div>
            <div class="card-body">
                <div class="info-list">
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-map-marker-alt me-2"></i>Address</span>
                        <span class="info-value">{{ restaurant.address or 'None' }}<br>{{ restaurant.city }} {{ restaurant.state or '' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-phone me-2"></i>Phone</span>
                        <span class="info-value">{{ restaurant.phone or 'Not set' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-envelope me-2"></i>Email</span>
                        <span class="info-value">{{ restaurant.email or current_user.email }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-eye me-2"></i>Status</span>
                        <span class="info-value">
                            <span class="badge bg-{{ 'success' if restaurant.is_active else 'secondary' }}">
                                {{ 'Active' if restaurant.is_active else 'Inactive' }}
                            </span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tables -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Tables</h5>
                <a href="{{ url_for('admin.add_table', restaurant_id=restaurant.id) }}" class="btn btn-sm btn-success">
                    <i class="fas fa-plus me-1"></i>Add
                </a>
            </div>
            <div class="card-body">
                {% if restaurant.tables %}
                <div class="table-grid">
                    {% for table in restaurant.tables %}
                    <div class="table-item {{ 'active' if table.is_active else 'inactive' }}">
                        <span class="table-number">{{ table.name }}</span>
                        <span class="table-capacity">{{ table.capacity }} seats</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted mb-0">No tables configured yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Reservations -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Recent Reservations</h5>
        <a href="{{ url_for('admin.reservations') }}?restaurant_id={{ restaurant.id }}" class="btn btn-sm btn-outline-primary">View All</a>
    </div>
    {% if recent_reservations %}
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>Customer</th>
                    <th>Date & Time</th>
                    <th>Party</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for res in recent_reservations[:5] %}
                <tr>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="user-avatar small">{{ res.customer_name[0]|upper if res.customer_name else 'G' }}</div>
                            <div>
                                <div class="fw-semibold">{{ res.customer_name }}</div>
                                <small class="text-muted">{{ res.customer_phone or res.customer_email or '' }}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        {{ res.reservation_date.strftime('%b %d, %Y') }}<br>
                        <small class="text-muted">{{ res.reservation_time.strftime('%H:%M') if res.reservation_time else '' }}</small>
                    </td>
                    <td>{{ res.party_size }} guests</td>
                    <td>
                        <span class="badge bg-{{ 'success' if res.status == 'confirmed' else 'warning' if res.status == 'pending' else 'danger' if res.status == 'cancelled' else 'info' }}">
                            {{ res.status|title }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state py-4">
        <div class="empty-state-icon small">
            <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="empty-state-title">No reservations yet</div>
        <div class="empty-state-text">Reservations made through the AI assistant will appear here.</div>
    </div>
    {% endif %}
</div>

<style>
.info-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.info-row {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.info-label {
    font-size: 0.75rem;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.info-value {
    font-size: 0.9375rem;
    color: #1e293b;
}

.table-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 0.5rem;
}

.table-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.75rem;
    border-radius: 8px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
}

.table-item.active {
    background: #d1fae5;
    border-color: #a7f3d0;
}

.table-item.inactive {
    background: #f1f5f9;
    opacity: 0.6;
}

.table-number {
    font-weight: 600;
    color: #1e293b;
}

.table-capacity {
    font-size: 0.75rem;
    color: #64748b;
}

/* Chat Container */
.chat-container {
    display: flex;
    flex-direction: column;
    height: 500px;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    background: #f8fafc;
}

.message {
    display: flex;
    gap: 0.75rem;
    max-width: 85%;
}

.message.user {
    flex-direction: row-reverse;
    align-self: flex-end;
}

.message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.message.assistant .message-avatar {
    background: linear-gradient(135deg, #2D8B7A, #4ECDC4);
    color: white;
}

.message.user .message-avatar {
    background: #e2e8f0;
    color: #64748b;
}

.message-content {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.message-text {
    padding: 0.875rem 1rem;
    border-radius: 1rem;
    line-height: 1.5;
}

.message.assistant .message-text {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 1rem 1rem 1rem 0;
}

.message.user .message-text {
    background: linear-gradient(135deg, #2D8B7A, #4ECDC4);
    color: white;
    border-radius: 1rem 1rem 0 1rem;
}

/* Chat Buttons */
.chat-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.chat-btn {
    padding: 0.5rem 1rem;
    border-radius: 1.5rem;
    border: 1px solid #e2e8f0;
    background: white;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
}

.chat-btn:hover:not(:disabled) {
    background: #f1f5f9;
    border-color: #2D8B7A;
    transform: translateY(-1px);
}

.chat-btn.confirm {
    background: #2D8B7A;
    color: white;
    border-color: #2D8B7A;
}

.chat-btn.confirm:hover:not(:disabled) {
    background: #236b5c;
    border-color: #236b5c;
}

.chat-btn.cancel {
    border-color: #dc3545;
    color: #dc3545;
}

.chat-btn.cancel:hover:not(:disabled) {
    background: #dc3545;
    color: white;
}

.chat-btn.selected {
    background: #2D8B7A;
    color: white;
    border-color: #2D8B7A;
}

.chat-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Booking Summary Card */
.booking-summary {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 0.75rem;
    padding: 1rem;
    margin-top: 0.75rem;
    white-space: pre-line;
}

/* Chat Input Container */
.chat-input-container {
    display: flex;
    gap: 0.5rem;
    padding: 1rem;
    background: white;
    border-top: 1px solid #e2e8f0;
}

.chat-input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 1.5rem;
    font-size: 0.9375rem;
    outline: none;
    transition: border-color 0.2s;
}

.chat-input:focus {
    border-color: #2D8B7A;
}

.chat-send-btn,
.chat-voice-btn,
.chat-whatsapp-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
}

.chat-send-btn {
    background: linear-gradient(135deg, #2D8B7A, #4ECDC4);
    color: white;
}

.chat-send-btn:hover {
    transform: scale(1.05);
}

.chat-voice-btn {
    background: #f1f5f9;
    color: #64748b;
}

.chat-voice-btn:hover {
    background: #e2e8f0;
}

.chat-voice-btn.recording {
    background: #ef4444;
    color: white;
    animation: pulse 1s infinite;
}

/* WhatsApp Button */
.chat-whatsapp-btn {
    background: #25D366;
    color: white;
}

.chat-whatsapp-btn:hover {
    background: #128C7E;
    transform: scale(1.05);
    color: white;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.user-avatar.small {
    width: 32px;
    height: 32px;
    font-size: 0.75rem;
}

.typing-dots span {
    animation: blink 1.4s infinite both;
}
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink {
    0%, 100% { opacity: 0.2; }
    50% { opacity: 1; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const voiceBtn = document.getElementById('voiceBtn');

    // Conversation history with state tracking
    let conversationHistory = [];
    let currentConversationState = null;  // Stores the Pydantic state from backend

    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];

    /**
     * Parse the API response which may be:
     * 1. A JSON string containing {text, buttons, button_type, conversation_state}
     * 2. Already a parsed object
     * 3. Plain text
     */
    function parseResponse(response) {
        console.log('=== PARSING RESPONSE ===');
        console.log('Response type:', typeof response);
        console.log('Response value:', response);

        // If response is already an object with 'text' property, use it directly
        if (response && typeof response === 'object' && response.text) {
            console.log('Response is already a parsed object with text');
            return {
                text: response.text,
                buttons: response.buttons || null,
                buttonType: response.button_type || null,
                conversationState: response.conversation_state || null
            };
        }

        // If response is a string, try to parse it as JSON
        if (typeof response === 'string') {
            // First, check if it looks like JSON
            const trimmed = response.trim();
            if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
                try {
                    const parsed = JSON.parse(trimmed);
                    console.log('Successfully parsed JSON:', parsed);
                    if (parsed.text) {
                        return {
                            text: parsed.text,
                            buttons: parsed.buttons || null,
                            buttonType: parsed.button_type || null,
                            conversationState: parsed.conversation_state || null
                        };
                    }
                } catch (e) {
                    console.error('JSON parse error:', e.message);
                    console.log('Failed to parse string:', trimmed.substring(0, 200));
                }
            }
        }

        // Fallback: treat as plain text
        console.log('Using response as plain text');
        return {
            text: String(response),
            buttons: null,
            buttonType: null,
            conversationState: null
        };
    }

    // Send message
    function sendMessage(messageOverride = null) {
        const message = messageOverride || chatInput.value.trim();
        if (!message) return;

        addMessage(message, 'user');
        if (!messageOverride) {
            chatInput.value = '';
        }

        // Build conversation history entry with state
        const historyEntry = { role: 'user', content: message };
        conversationHistory.push(historyEntry);

        // Show typing indicator
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message assistant typing';
        typingDiv.innerHTML = `
            <div class="message-avatar"><i class="fas fa-robot"></i></div>
            <div class="message-content">
                <div class="message-text">
                    <span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
                </div>
            </div>
        `;
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Build request with conversation state
        const requestBody = {
            restaurant_id: {{ restaurant.id }},
            message: message,
            conversation_history: conversationHistory
        };

        console.log('=== SENDING REQUEST ===');
        console.log('Request body:', requestBody);

        // Send to API
        fetch('/api/ai/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        })
        .then(response => {
            console.log('=== RAW RESPONSE ===');
            console.log('Status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('=== API RESPONSE DATA ===');
            console.log('Full data object:', data);
            console.log('data.success:', data.success);
            console.log('data.response:', data.response);
            console.log('data.response type:', typeof data.response);

            // Remove typing indicator
            typingDiv.remove();

            if (data.success) {
                // Parse the response using our robust parser
                const parsed = parseResponse(data.response);

                console.log('=== PARSED RESULT ===');
                console.log('Text:', parsed.text);
                console.log('Buttons:', parsed.buttons);
                console.log('Button type:', parsed.buttonType);

                // Store the conversation state for next request
                if (parsed.conversationState) {
                    currentConversationState = parsed.conversationState;
                }

                addMessage(parsed.text, 'assistant', parsed.buttons, parsed.buttonType);

                // Add to history with state
                conversationHistory.push({
                    role: 'assistant',
                    content: parsed.text,
                    conversation_state: parsed.conversationState
                });
            } else {
                console.error('API returned success=false:', data);
                addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
            }
        })
        .catch(error => {
            typingDiv.remove();
            console.error('=== FETCH ERROR ===');
            console.error('Chat error:', error);
            addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
        });
    }

    function addMessage(text, sender, buttons = null, buttonType = null) {
        console.log('=== ADD MESSAGE ===');
        console.log('Text:', text);
        console.log('Sender:', sender);
        console.log('Buttons:', buttons);
        console.log('Button type:', buttonType);

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;

        // Format text with line breaks
        const formattedText = text.replace(/\n/g, '<br>');

        let contentHtml = `
            <div class="message-avatar">
                <i class="fas fa-${sender === 'user' ? 'user' : 'robot'}"></i>
            </div>
            <div class="message-content">
                <div class="message-text">${formattedText}</div>
        `;

        // Add buttons if present
        if (buttons && Array.isArray(buttons) && buttons.length > 0) {
            console.log('=== RENDERING BUTTONS ===');
            console.log('Number of buttons:', buttons.length);

            contentHtml += '<div class="chat-buttons">';
            buttons.forEach((btn, index) => {
                console.log(`Button ${index}:`, btn);
                let btnClass = 'chat-btn';
                if (btn.value === 'confirm') btnClass += ' confirm';
                if (btn.value === 'cancel') btnClass += ' cancel';

                contentHtml += `<button class="${btnClass}" data-value="${btn.value}" data-display="${btn.display}" data-type="${buttonType || ''}">${btn.display}</button>`;
            });
            contentHtml += '</div>';
        }

        contentHtml += '</div>';
        messageDiv.innerHTML = contentHtml;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Add click handlers for buttons
        if (buttons && Array.isArray(buttons) && buttons.length > 0) {
            const buttonElements = messageDiv.querySelectorAll('.chat-btn');
            buttonElements.forEach(btn => {
                btn.addEventListener('click', function() {
                    const value = this.dataset.value;
                    const display = this.dataset.display;
                    const type = this.dataset.type;
                    handleButtonClick(value, display, type, this);
                });
            });
        }
    }

    function handleButtonClick(value, display, type, buttonElement) {
        console.log('=== BUTTON CLICK ===');
        console.log('Value:', value);
        console.log('Display:', display);
        console.log('Type:', type);

        // Disable all buttons in this group
        const buttonContainer = buttonElement.parentElement;
        const allButtons = buttonContainer.querySelectorAll('.chat-btn');
        allButtons.forEach(btn => {
            btn.disabled = true;
            if (btn === buttonElement) {
                btn.classList.add('selected');
            }
        });

        // Determine what message to send based on button type
        let messageToSend = value;  // Default: send the value

        switch (type) {
            case 'date':
                // For dates, send the YYYY-MM-DD value directly
                messageToSend = value;
                break;
            case 'guests':
                // For guests, send the number or '9+'
                messageToSend = value;
                break;
            case 'confirm':
                // For confirm/cancel, send the value
                messageToSend = value;
                break;
            default:
                messageToSend = value;
        }

        // Show the display text as user message but send the value
        addMessage(display, 'user');

        // Add to history
        conversationHistory.push({ role: 'user', content: messageToSend });

        // Show typing indicator
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message assistant typing';
        typingDiv.innerHTML = `
            <div class="message-avatar"><i class="fas fa-robot"></i></div>
            <div class="message-content">
                <div class="message-text">
                    <span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
                </div>
            </div>
        `;
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Send to API
        fetch('/api/ai/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                restaurant_id: {{ restaurant.id }},
                message: messageToSend,
                conversation_history: conversationHistory
            })
        })
        .then(response => response.json())
        .then(data => {
            typingDiv.remove();

            if (data.success) {
                // Parse the response using our robust parser
                const parsed = parseResponse(data.response);

                if (parsed.conversationState) {
                    currentConversationState = parsed.conversationState;
                }

                addMessage(parsed.text, 'assistant', parsed.buttons, parsed.buttonType);
                conversationHistory.push({
                    role: 'assistant',
                    content: parsed.text,
                    conversation_state: parsed.conversationState
                });
            } else {
                addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
            }
        })
        .catch(error => {
            typingDiv.remove();
            console.error('Button click error:', error);
            addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
        });
    }

    // Event listeners
    sendBtn.addEventListener('click', function() { sendMessage(); });
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendMessage();
    });

    // Voice recording
    voiceBtn.addEventListener('click', async function() {
        if (!isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const formData = new FormData();
                    formData.append('audio', audioBlob);
                    formData.append('restaurant_id', {{ restaurant.id }});
                    formData.append('conversation_history', JSON.stringify(conversationHistory));

                    addMessage('ðŸŽ¤ Processing voice...', 'user');

                    try {
                        const response = await fetch('/api/ai/voice-chat', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();

                        console.log('=== VOICE CHAT RESPONSE ===');
                        console.log('Full data:', data);
                        console.log('user_text:', data.user_text);
                        console.log('ai_response:', data.ai_response);
                        console.log('ai_response type:', typeof data.ai_response);

                        chatMessages.lastChild.remove();

                        if (data.success) {
                            // Show the transcribed user message
                            addMessage(data.user_text, 'user');
                            conversationHistory.push({ role: 'user', content: data.user_text });

                            // Parse the AI response using our robust parser (same as text chat)
                            const parsed = parseResponse(data.ai_response);

                            console.log('=== VOICE PARSED RESULT ===');
                            console.log('Text:', parsed.text);
                            console.log('Buttons:', parsed.buttons);
                            console.log('Button type:', parsed.buttonType);

                            // Store conversation state
                            if (parsed.conversationState) {
                                currentConversationState = parsed.conversationState;
                            }

                            // Add the AI response with buttons
                            addMessage(parsed.text, 'assistant', parsed.buttons, parsed.buttonType);
                            conversationHistory.push({
                                role: 'assistant',
                                content: parsed.text,
                                conversation_state: parsed.conversationState
                            });
                        } else {
                            addMessage('Sorry, I encountered an error processing your voice message.', 'assistant');
                        }
                    } catch (error) {
                        console.error('Voice chat error:', error);
                        chatMessages.lastChild.remove();
                        addMessage('Sorry, voice processing failed.', 'assistant');
                    }

                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                voiceBtn.classList.add('recording');
            } catch (error) {
                alert('Microphone access denied');
            }
        } else {
            mediaRecorder.stop();
            isRecording = false;
            voiceBtn.classList.remove('recording');
        }
    });
});
</script>
{% endblock %}
