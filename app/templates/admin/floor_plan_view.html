{% extends "admin/base.html" %}

{% block title %}Floor Plan - {{ restaurant.name }}{% endblock %}

{% block extra_css %}
<style>
    .floor-plan-view-container {
        display: flex;
        gap: 20px;
        height: calc(100vh - 200px);
        min-height: 600px;
    }
    
    /* Status Legend Panel */
    .legend-panel {
        width: 220px;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        flex-shrink: 0;
    }
    
    .legend-panel h5 {
        margin-bottom: 15px;
        color: #333;
        font-weight: 600;
        border-bottom: 2px solid #ddd;
        padding-bottom: 10px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        margin-bottom: 5px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .legend-item:hover {
        background: rgba(0,0,0,0.05);
    }
    
    .legend-color {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        flex-shrink: 0;
    }
    
    .legend-text {
        font-size: 13px;
        color: #333;
    }
    
    .legend-count {
        margin-left: auto;
        background: #fff;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 600;
        color: #666;
    }
    
    /* Status Colors */
    .status-free { background-color: #4CAF50; }
    .status-reserved { background-color: #f44336; }
    .status-reserved_spare { background-color: #FF9800; }
    .status-seated { background-color: #9C27B0; }
    .status-completed { background-color: #FFEB3B; }
    
    /* Canvas Container */
    .canvas-container {
        flex: 1;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .canvas-toolbar {
        background: #f8f9fa;
        padding: 10px 15px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .canvas-toolbar h4 {
        margin: 0;
        color: #333;
    }
    
    .canvas-toolbar .btn-group {
        margin-left: auto;
    }
    
    .canvas-wrapper {
        flex: 1;
        overflow: auto;
        padding: 20px;
        background: #e8e8e8;
    }
    
    #floorPlanCanvas {
        background: #1a1a1a;
        border-radius: 8px;
        cursor: default;
    }
    
    /* Details Panel */
    .details-panel {
        width: 300px;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
    }
    
    .details-panel h5 {
        margin-bottom: 15px;
        color: #333;
        font-weight: 600;
        border-bottom: 2px solid #ddd;
        padding-bottom: 10px;
    }
    
    .table-details {
        flex: 1;
    }
    
    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .detail-label {
        color: #666;
        font-size: 13px;
    }
    
    .detail-value {
        font-weight: 500;
        color: #333;
    }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        color: #fff;
        text-transform: uppercase;
    }
    
    .status-badge.free { background: #4CAF50; }
    .status-badge.reserved { background: #f44336; }
    .status-badge.reserved_spare { background: #FF9800; }
    .status-badge.seated { background: #9C27B0; }
    .status-badge.completed { background: #FFEB3B; color: #333; }
    
    /* Status Actions */
    .status-actions {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 2px solid #ddd;
    }
    
    .status-actions h6 {
        margin-bottom: 10px;
        color: #333;
        font-weight: 600;
    }
    
    .status-btn-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }
    
    .status-btn {
        padding: 10px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        color: #fff;
    }
    
    .status-btn:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .status-btn.free { background: #4CAF50; }
    .status-btn.reserved { background: #f44336; }
    .status-btn.reserved_spare { background: #FF9800; }
    .status-btn.seated { background: #9C27B0; }
    .status-btn.completed { background: #FFEB3B; color: #333; }
    
    .status-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    /* Guest Info Form */
    .guest-info-form {
        margin-top: 15px;
        padding: 15px;
        background: #fff;
        border-radius: 8px;
        display: none;
    }
    
    .guest-info-form.show {
        display: block;
    }
    
    .guest-info-form .form-group {
        margin-bottom: 12px;
    }
    
    .guest-info-form label {
        font-size: 12px;
        color: #666;
        margin-bottom: 4px;
        display: block;
    }
    
    .guest-info-form input,
    .guest-info-form textarea,
    .guest-info-form select {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
    }
    
    .guest-info-form textarea {
        resize: vertical;
        min-height: 60px;
    }
    
    /* No Selection State */
    .no-selection {
        text-align: center;
        color: #999;
        padding: 40px 20px;
    }
    
    .no-selection i {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
    }
    
    /* Upcoming Reservations */
    .upcoming-reservations {
        margin-top: auto;
        padding-top: 15px;
        border-top: 2px solid #ddd;
    }
    
    .upcoming-reservations h6 {
        margin-bottom: 10px;
        color: #333;
        font-weight: 600;
    }
    
    .reservation-item {
        background: #fff;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
        border-left: 3px solid #2196F3;
    }
    
    .reservation-item .time {
        font-weight: 600;
        color: #2196F3;
    }
    
    .reservation-item .guest {
        font-size: 13px;
        color: #333;
    }
    
    .reservation-item .party {
        font-size: 12px;
        color: #666;
    }
    
    /* Auto-refresh indicator */
    .refresh-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #666;
    }
    
    .refresh-indicator .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #4CAF50;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    /* Table hover effect on canvas */
    .table-hover-info {
        position: absolute;
        background: rgba(0,0,0,0.85);
        color: #fff;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        pointer-events: none;
        z-index: 1000;
        display: none;
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-map me-2"></i>Floor Plan View</h2>
        <p class="text-muted mb-0">{{ restaurant.name }} - Real-time table status management</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('admin.floor_plan_editor', restaurant_id=restaurant.id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-edit me-1"></i> Edit Layout
        </a>
        <a href="{{ url_for('admin.restaurant_detail', id=restaurant.id) }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-1"></i> Back to Restaurant
        </a>
    </div>
</div>

<div class="floor-plan-view-container">
    <!-- Left Panel - Legend -->
    <div class="legend-panel">
        <h5><i class="fas fa-palette me-2"></i>Status Legend</h5>
        
        <div class="legend-item" data-filter="all">
            <div class="legend-color" style="background: linear-gradient(135deg, #4CAF50, #f44336, #9C27B0);"></div>
            <span class="legend-text">All Tables</span>
            <span class="legend-count" id="count-all">0</span>
        </div>
        
        <div class="legend-item" data-filter="free">
            <div class="legend-color status-free"></div>
            <span class="legend-text">Free</span>
            <span class="legend-count" id="count-free">0</span>
        </div>
        
        <div class="legend-item" data-filter="reserved">
            <div class="legend-color status-reserved"></div>
            <span class="legend-text">Reserved</span>
            <span class="legend-count" id="count-reserved">0</span>
        </div>
        
        <div class="legend-item" data-filter="reserved_spare">
            <div class="legend-color status-reserved_spare"></div>
            <span class="legend-text">Reserved (Spare)</span>
            <span class="legend-count" id="count-reserved_spare">0</span>
        </div>
        
        <div class="legend-item" data-filter="seated">
            <div class="legend-color status-seated"></div>
            <span class="legend-text">Seated</span>
            <span class="legend-count" id="count-seated">0</span>
        </div>
        
        <div class="legend-item" data-filter="completed">
            <div class="legend-color status-completed"></div>
            <span class="legend-text">Needs Cleaning</span>
            <span class="legend-count" id="count-completed">0</span>
        </div>
        
        <hr>
        
        <div class="refresh-indicator">
            <span class="dot"></span>
            <span>Auto-refresh: <span id="refresh-countdown">30</span>s</span>
        </div>
        
        <button class="btn btn-sm btn-outline-primary w-100 mt-2" onclick="loadFloorPlan()">
            <i class="fas fa-sync-alt me-1"></i> Refresh Now
        </button>
    </div>
    
    <!-- Center - Canvas -->
    <div class="canvas-container">
        <div class="canvas-toolbar">
            <h4 id="floorPlanName">Loading...</h4>
            <div class="refresh-indicator ms-3">
                <span class="dot"></span>
                <span>Live</span>
            </div>
            <div class="btn-group ms-auto">
                <button class="btn btn-sm btn-outline-secondary" onclick="zoomIn()">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="zoomOut()">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="resetZoom()">
                    <i class="fas fa-compress-arrows-alt"></i>
                </button>
            </div>
        </div>
        <div class="canvas-wrapper">
            <canvas id="floorPlanCanvas"></canvas>
        </div>
    </div>
    
    <!-- Right Panel - Details -->
    <div class="details-panel">
        <h5><i class="fas fa-info-circle me-2"></i>Table Details</h5>
        
        <div id="noSelection" class="no-selection">
            <i class="fas fa-hand-pointer"></i>
            <p>Click on a table to view details and change status</p>
        </div>
        
        <div id="tableDetails" class="table-details" style="display: none;">
            <div class="detail-row">
                <span class="detail-label">Table</span>
                <span class="detail-value" id="detail-table-id">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Name</span>
                <span class="detail-value" id="detail-table-name">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Capacity</span>
                <span class="detail-value" id="detail-seats">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Type</span>
                <span class="detail-value" id="detail-type">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Status</span>
                <span class="detail-value"><span class="status-badge" id="detail-status">-</span></span>
            </div>
            <div class="detail-row" id="detail-guest-row" style="display: none;">
                <span class="detail-label">Guest</span>
                <span class="detail-value" id="detail-guest-name">-</span>
            </div>
            <div class="detail-row" id="detail-party-row" style="display: none;">
                <span class="detail-label">Party Size</span>
                <span class="detail-value" id="detail-guest-count">-</span>
            </div>
            <div class="detail-row" id="detail-reservation-time-row" style="display: none;">
                <span class="detail-label">Reservation</span>
                <span class="detail-value" id="detail-reservation-time">-</span>
            </div>
            <div class="detail-row" id="detail-notes-row" style="display: none;">
                <span class="detail-label">Notes</span>
                <span class="detail-value" id="detail-notes">-</span>
            </div>
            
            <!-- Status Actions -->
            <div class="status-actions">
                <h6>Change Status</h6>
                <div class="status-btn-grid">
                    <button class="status-btn free" onclick="setTableStatus('free')">
                        <i class="fas fa-check me-1"></i> Free
                    </button>
                    <button class="status-btn reserved" onclick="showGuestForm('reserved')">
                        <i class="fas fa-calendar me-1"></i> Reserved
                    </button>
                    <button class="status-btn reserved_spare" onclick="showGuestForm('reserved_spare')">
                        <i class="fas fa-shield-alt me-1"></i> Spare
                    </button>
                    <button class="status-btn seated" onclick="showGuestForm('seated')">
                        <i class="fas fa-user-check me-1"></i> Seated
                    </button>
                    <button class="status-btn completed" onclick="setTableStatus('completed')" style="grid-column: span 2;">
                        <i class="fas fa-broom me-1"></i> Needs Cleaning
                    </button>
                </div>
            </div>
            
            <!-- Guest Info Form -->
            <div class="guest-info-form" id="guestInfoForm">
                <div class="form-group">
                    <label>Guest Name</label>
                    <input type="text" id="input-guest-name" placeholder="Enter guest name">
                </div>
                <div class="form-group">
                    <label>Party Size</label>
                    <input type="number" id="input-guest-count" min="1" max="20" placeholder="Number of guests">
                </div>
                <div class="form-group">
                    <label>Link to Reservation (Optional)</label>
                    <select id="input-reservation">
                        <option value="">-- No reservation --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="input-notes" placeholder="Any special notes..."></textarea>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary flex-grow-1" onclick="confirmStatusChange()">
                        <i class="fas fa-check me-1"></i> Confirm
                    </button>
                    <button class="btn btn-outline-secondary" onclick="hideGuestForm()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Upcoming Reservations for Selected Table -->
        <div class="upcoming-reservations" id="upcomingReservations" style="display: none;">
            <h6><i class="fas fa-clock me-2"></i>Today's Reservations</h6>
            <div id="reservationsList">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Hover tooltip -->
<div class="table-hover-info" id="tableHoverInfo"></div>
{% endblock %}

{% block extra_js %}
<script>
    // Configuration
    const restaurantId = {{ restaurant.id }};
    const REFRESH_INTERVAL = 30; // seconds
    
    // Status colors
    const STATUS_COLORS = {
        'free': '#4CAF50',
        'reserved': '#f44336',
        'reserved_spare': '#FF9800',
        'seated': '#9C27B0',
        'completed': '#FFEB3B'
    };
    
    const STATUS_LABELS = {
        'free': 'Free',
        'reserved': 'Reserved',
        'reserved_spare': 'Reserved (Spare)',
        'seated': 'Seated',
        'completed': 'Needs Cleaning'
    };
    
    // State
    let canvas, ctx;
    let floorPlanData = null;
    let selectedTable = null;
    let pendingStatus = null;
    let zoomLevel = 1;
    let refreshCountdown = REFRESH_INTERVAL;
    let refreshTimer = null;
    let todayReservations = [];
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        canvas = document.getElementById('floorPlanCanvas');
        ctx = canvas.getContext('2d');
        
        // Add event listeners
        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('mousemove', handleCanvasHover);
        canvas.addEventListener('mouseleave', hideHoverInfo);
        
        // Load floor plan
        loadFloorPlan();
        
        // Start auto-refresh
        startAutoRefresh();
        
        // Load today's reservations
        loadTodayReservations();
    });
    
    // Auto-refresh
    function startAutoRefresh() {
        refreshCountdown = REFRESH_INTERVAL;
        updateCountdownDisplay();
        
        refreshTimer = setInterval(() => {
            refreshCountdown--;
            updateCountdownDisplay();
            
            if (refreshCountdown <= 0) {
                loadFloorPlan();
                refreshCountdown = REFRESH_INTERVAL;
            }
        }, 1000);
    }
    
    function updateCountdownDisplay() {
        document.getElementById('refresh-countdown').textContent = refreshCountdown;
    }
    
    // Load floor plan data
    async function loadFloorPlan() {
        try {
            const response = await fetch(`/admin/restaurants/${restaurantId}/floor-plan/data`);
            const data = await response.json();
            
            if (data.success && data.floor_plan) {
                floorPlanData = data.floor_plan;
                document.getElementById('floorPlanName').textContent = floorPlanData.name || 'Floor Plan';
                renderFloorPlan();
                updateStatusCounts();
                
                // Update selected table if still exists
                if (selectedTable) {
                    const updatedTable = floorPlanData.tables.find(t => t.id === selectedTable.id);
                    if (updatedTable) {
                        selectedTable = updatedTable;
                        showTableDetails(selectedTable);
                    }
                }
            } else {
                showNoFloorPlan();
            }
        } catch (error) {
            console.error('Error loading floor plan:', error);
            showNoFloorPlan();
        }
    }
    
    function showNoFloorPlan() {
        document.getElementById('floorPlanName').textContent = 'No Floor Plan';
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#333';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#fff';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No floor plan configured. Click "Edit Layout" to create one.', canvas.width/2, canvas.height/2);
    }
    
    // Render floor plan
    function renderFloorPlan() {
        if (!floorPlanData) return;
        
        const cellSize = (floorPlanData.cell_size || 40) * zoomLevel;
        const rows = floorPlanData.grid_rows || 20;
        const cols = floorPlanData.grid_cols || 20;
        
        canvas.width = cols * cellSize;
        canvas.height = rows * cellSize;
        
        // Clear canvas
        ctx.fillStyle = '#1a1a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw floor cells
        const floorColor = floorPlanData.floor_color || '#404040';
        if (floorPlanData.floor_cells) {
            floorPlanData.floor_cells.forEach(cell => {
                ctx.fillStyle = cell.color || floorColor;
                ctx.fillRect(cell.pos_x * cellSize, cell.pos_y * cellSize, cellSize, cellSize);
            });
        }
        
        // Draw tables with status colors
        if (floorPlanData.tables) {
            floorPlanData.tables.forEach(table => {
                drawTable(table, cellSize);
            });
        }
    }
    
    function drawTable(table, cellSize) {
        const x = table.pos_x * cellSize;
        const y = table.pos_y * cellSize;
        const width = table.width * cellSize;
        const height = table.height * cellSize;
        
        // Get status color
        const status = table.current_status || 'free';
        const baseColor = STATUS_COLORS[status] || STATUS_COLORS.free;
        
        // Highlight selected table
        const isSelected = selectedTable && selectedTable.id === table.id;
        
        ctx.save();
        
        // Draw shadow for selected
        if (isSelected) {
            ctx.shadowColor = 'rgba(255,255,255,0.5)';
            ctx.shadowBlur = 15;
        }
        
        // Draw table shape
        ctx.fillStyle = baseColor;
        ctx.strokeStyle = isSelected ? '#fff' : 'rgba(0,0,0,0.3)';
        ctx.lineWidth = isSelected ? 3 : 1;
        
        if (table.shape === 'circle') {
            const radius = Math.min(width, height) / 2 - 4;
            ctx.beginPath();
            ctx.arc(x + width/2, y + height/2, radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
        } else {
            const radius = table.shape === 'rectangle' ? 8 : 4;
            roundRect(ctx, x + 4, y + 4, width - 8, height - 8, radius);
            ctx.fill();
            ctx.stroke();
        }
        
        ctx.restore();
        
        // Draw table ID
        ctx.fillStyle = status === 'completed' ? '#333' : '#fff';
        ctx.font = `bold ${12 * zoomLevel}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(table.table_id, x + width/2, y + height/2 - 6 * zoomLevel);
        
        // Draw seats count
        ctx.font = `${10 * zoomLevel}px Arial`;
        ctx.fillText(`${table.seats} seats`, x + width/2, y + height/2 + 8 * zoomLevel);
        
        // Draw guest name if seated or reserved
        if ((status === 'seated' || status === 'reserved') && table.current_guest_name) {
            ctx.font = `${9 * zoomLevel}px Arial`;
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            const name = table.current_guest_name.length > 10 
                ? table.current_guest_name.substring(0, 10) + '...' 
                : table.current_guest_name;
            ctx.fillText(name, x + width/2, y + height/2 + 20 * zoomLevel);
        }
    }
    
    function roundRect(ctx, x, y, width, height, radius) {
        ctx.beginPath();
        ctx.moveTo(x + radius, y);
        ctx.lineTo(x + width - radius, y);
        ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
        ctx.lineTo(x + width, y + height - radius);
        ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
        ctx.lineTo(x + radius, y + height);
        ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
        ctx.lineTo(x, y + radius);
        ctx.quadraticCurveTo(x, y, x + radius, y);
        ctx.closePath();
    }
    
    // Handle canvas click
    function handleCanvasClick(e) {
        if (!floorPlanData || !floorPlanData.tables) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const cellSize = (floorPlanData.cell_size || 40) * zoomLevel;
        
        // Find clicked table
        const clickedTable = floorPlanData.tables.find(table => {
            const tx = table.pos_x * cellSize;
            const ty = table.pos_y * cellSize;
            const tw = table.width * cellSize;
            const th = table.height * cellSize;
            return x >= tx && x <= tx + tw && y >= ty && y <= ty + th;
        });
        
        if (clickedTable) {
            selectedTable = clickedTable;
            showTableDetails(clickedTable);
            renderFloorPlan();
        } else {
            selectedTable = null;
            hideTableDetails();
            renderFloorPlan();
        }
    }
    
    // Handle canvas hover
    function handleCanvasHover(e) {
        if (!floorPlanData || !floorPlanData.tables) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const cellSize = (floorPlanData.cell_size || 40) * zoomLevel;
        
        const hoveredTable = floorPlanData.tables.find(table => {
            const tx = table.pos_x * cellSize;
            const ty = table.pos_y * cellSize;
            const tw = table.width * cellSize;
            const th = table.height * cellSize;
            return x >= tx && x <= tx + tw && y >= ty && y <= ty + th;
        });
        
        if (hoveredTable) {
            canvas.style.cursor = 'pointer';
            showHoverInfo(hoveredTable, e.clientX, e.clientY);
        } else {
            canvas.style.cursor = 'default';
            hideHoverInfo();
        }
    }
    
    function showHoverInfo(table, x, y) {
        const info = document.getElementById('tableHoverInfo');
        const status = table.current_status || 'free';
        
        let html = `<strong>${table.table_id}</strong> - ${STATUS_LABELS[status]}`;
        if (table.current_guest_name) {
            html += `<br>Guest: ${table.current_guest_name}`;
        }
        if (table.current_guest_count) {
            html += `<br>Party: ${table.current_guest_count}`;
        }
        
        info.innerHTML = html;
        info.style.left = (x + 15) + 'px';
        info.style.top = (y + 15) + 'px';
        info.style.display = 'block';
    }
    
    function hideHoverInfo() {
        document.getElementById('tableHoverInfo').style.display = 'none';
    }
    
    // Show table details
    function showTableDetails(table) {
        document.getElementById('noSelection').style.display = 'none';
        document.getElementById('tableDetails').style.display = 'block';
        document.getElementById('upcomingReservations').style.display = 'block';
        
        const status = table.current_status || 'free';
        
        document.getElementById('detail-table-id').textContent = table.table_id;
        document.getElementById('detail-table-name').textContent = table.table_name || '-';
        document.getElementById('detail-seats').textContent = table.seats + ' seats';
        document.getElementById('detail-type').textContent = table.table_type || 'Standard';
        
        const statusBadge = document.getElementById('detail-status');
        statusBadge.textContent = STATUS_LABELS[status];
        statusBadge.className = 'status-badge ' + status;
        
        // Show/hide guest info
        const showGuest = ['reserved', 'reserved_spare', 'seated'].includes(status);
        document.getElementById('detail-guest-row').style.display = showGuest ? 'flex' : 'none';
        document.getElementById('detail-party-row').style.display = showGuest ? 'flex' : 'none';
        document.getElementById('detail-notes-row').style.display = table.status_notes ? 'flex' : 'none';
        
        if (showGuest) {
            document.getElementById('detail-guest-name').textContent = table.current_guest_name || '-';
            document.getElementById('detail-guest-count').textContent = table.current_guest_count || '-';
        }
        if (table.status_notes) {
            document.getElementById('detail-notes').textContent = table.status_notes;
        }
        
        // Show linked reservation time range
        const resTimeRow = document.getElementById('detail-reservation-time-row');
        if (table.current_reservation_id && ['reserved', 'seated'].includes(status)) {
            const linkedRes = todayReservations.find(r => r.id === table.current_reservation_id);
            if (linkedRes) {
                const endTime = calculateEndTime(linkedRes.reservation_time, linkedRes.duration_minutes || 90);
                document.getElementById('detail-reservation-time').innerHTML = 
                    `<span style="color: #2196F3; font-weight: 600;">${linkedRes.reservation_time} - ${endTime}</span>`;
                resTimeRow.style.display = 'flex';
            } else {
                resTimeRow.style.display = 'none';
            }
        } else if (['reserved', 'seated'].includes(status)) {
            // Try to find a matching reservation by table
            const matchingRes = todayReservations.find(r => {
                const tableMatch = r.table_id && floorPlanData.tables.find(t => 
                    t.id === table.id && r.table_id === parseInt(t.table_id.replace(/\D/g, '')));
                return tableMatch;
            });
            if (matchingRes) {
                const endTime = calculateEndTime(matchingRes.reservation_time, matchingRes.duration_minutes || 90);
                document.getElementById('detail-reservation-time').innerHTML = 
                    `<span style="color: #2196F3; font-weight: 600;">${matchingRes.reservation_time} - ${endTime}</span>`;
                resTimeRow.style.display = 'flex';
            } else {
                resTimeRow.style.display = 'none';
            }
        } else {
            resTimeRow.style.display = 'none';
        }
        
        // Load reservations for this table
        loadTableReservations(table.table_id);
        
        // Hide guest form
        hideGuestForm();
    }
    
    function hideTableDetails() {
        document.getElementById('noSelection').style.display = 'block';
        document.getElementById('tableDetails').style.display = 'none';
        document.getElementById('upcomingReservations').style.display = 'none';
    }
    
    // Status change functions
    function showGuestForm(status) {
        pendingStatus = status;
        document.getElementById('guestInfoForm').classList.add('show');
        
        // Pre-fill if table has existing data
        if (selectedTable) {
            document.getElementById('input-guest-name').value = selectedTable.current_guest_name || '';
            document.getElementById('input-guest-count').value = selectedTable.current_guest_count || selectedTable.seats;
            document.getElementById('input-notes').value = selectedTable.status_notes || '';
        }
        
        // Populate reservation dropdown
        populateReservationDropdown();
    }
    
    function hideGuestForm() {
        document.getElementById('guestInfoForm').classList.remove('show');
        pendingStatus = null;
    }
    
    async function setTableStatus(status) {
        if (!selectedTable) return;
        
        const data = {
            status: status,
            guest_name: null,
            guest_count: null,
            reservation_id: null,
            notes: null
        };
        
        await updateTableStatus(data);
    }
    
    async function confirmStatusChange() {
        if (!selectedTable || !pendingStatus) return;
        
        const data = {
            status: pendingStatus,
            guest_name: document.getElementById('input-guest-name').value || null,
            guest_count: parseInt(document.getElementById('input-guest-count').value) || null,
            reservation_id: document.getElementById('input-reservation').value || null,
            notes: document.getElementById('input-notes').value || null
        };
        
        await updateTableStatus(data);
        hideGuestForm();
    }
    
    async function updateTableStatus(data) {
        try {
            const response = await fetch(`/api/floor-plan/table/${selectedTable.id}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Reload floor plan to get updated data
                await loadFloorPlan();
            } else {
                alert('Error updating table status: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error updating status:', error);
            alert('Error updating table status');
        }
    }
    
    // Update status counts
    function updateStatusCounts() {
        if (!floorPlanData || !floorPlanData.tables) return;
        
        const counts = {
            all: floorPlanData.tables.length,
            free: 0,
            reserved: 0,
            reserved_spare: 0,
            seated: 0,
            completed: 0
        };
        
        floorPlanData.tables.forEach(table => {
            const status = table.current_status || 'free';
            if (counts.hasOwnProperty(status)) {
                counts[status]++;
            }
        });
        
        Object.keys(counts).forEach(key => {
            const el = document.getElementById('count-' + key);
            if (el) el.textContent = counts[key];
        });
    }
    
    // Calculate end time from start time and duration
    function calculateEndTime(startTime, durationMinutes) {
        const [hours, minutes] = startTime.split(':').map(Number);
        const totalMinutes = hours * 60 + minutes + durationMinutes;
        const endHours = Math.floor(totalMinutes / 60) % 24;
        const endMinutes = totalMinutes % 60;
        return `${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}`;
    }
    
    // Load today's reservations
    async function loadTodayReservations() {
        try {
            const today = new Date().toISOString().split('T')[0];
            const response = await fetch(`/api/restaurants/${restaurantId}/reservations?date=${today}`);
            const data = await response.json();
            
            if (data.reservations) {
                todayReservations = data.reservations;
            }
        } catch (error) {
            console.error('Error loading reservations:', error);
        }
    }
    
    // Load reservations for specific table
    function loadTableReservations(tableId) {
        const list = document.getElementById('reservationsList');
        
        // Filter reservations for this table (if table_id matches)
        const tableReservations = todayReservations.filter(r => 
            r.table_id === tableId || !r.table_id // Show unassigned too
        ).slice(0, 5);
        
        if (tableReservations.length === 0) {
            list.innerHTML = '<p class="text-muted small">No reservations today</p>';
            return;
        }
        
        list.innerHTML = tableReservations.map(r => {
            const endTime = calculateEndTime(r.reservation_time, r.duration_minutes || 90);
            return `
            <div class="reservation-item">
                <div class="time">${r.reservation_time} - ${endTime}</div>
                <div class="guest">${r.customer_name}</div>
                <div class="party">${r.party_size} guests</div>
            </div>
            `;
        }).join('');
    }
    
    // Populate reservation dropdown
    function populateReservationDropdown() {
        const select = document.getElementById('input-reservation');
        select.innerHTML = '<option value="">-- No reservation --</option>';
        
        todayReservations.forEach(r => {
            const option = document.createElement('option');
            option.value = r.id;
            option.textContent = `${r.reservation_time} - ${r.customer_name} (${r.party_size})`;
            select.appendChild(option);
        });
    }
    
    // Zoom functions
    function zoomIn() {
        zoomLevel = Math.min(zoomLevel + 0.2, 2);
        renderFloorPlan();
    }
    
    function zoomOut() {
        zoomLevel = Math.max(zoomLevel - 0.2, 0.5);
        renderFloorPlan();
    }
    
    function resetZoom() {
        zoomLevel = 1;
        renderFloorPlan();
    }
</script>
{% endblock %}
